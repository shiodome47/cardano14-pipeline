---
layout: layouts/base.njk

pagination:
  data: f14                  # f14 は「配列」なので、.proposals は付けない
  size: 1
  alias: proposal

permalink: "/proposals/{{ proposal.proposal_id | lower }}/index.html"
---

<div class="max-w-5xl mx-auto py-10 px-4 sm:px-6 lg:px-8 space-y-10">

  {# タイトル & メタ #}
  <header class="space-y-3">
    <p class="text-xs font-medium tracking-wide text-slate-500 uppercase">
      Project Catalyst Fund {{ proposal.fund }} · CardanoCatalyst Pipeline
    </p>
    <h1 class="text-2xl sm:text-3xl font-bold tracking-tight text-slate-900">
      {{ proposal.title_ja or proposal.title_en }}
    </h1>
    <p class="text-sm text-slate-500">
      {{ proposal.proposal_id }} · Fund {{ proposal.fund }}
      {% if proposal.challenge %}
        · {{ proposal.challenge }}
      {% endif %}
    </p>
  </header>

  {# ステータス & 金額 #}
  <section
    class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 p-4 rounded-2xl bg-white/70 ring-1 ring-slate-200/70 shadow-sm"
  >
    <div class="flex items-center gap-3">
      {% set status = (proposal.status or "REQUESTED") | upper %}
      {% if status == "FUNDED" %}
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700 border border-emerald-200">
          FUNDED
        </span>
      {% elif status == "NOT FUNDED" %}
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-rose-100 text-rose-700 border border-rose-200">
          NOT FUNDED
        </span>
      {% else %}
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-700 border border-slate-200">
          REQUESTED
        </span>
      {% endif %}

      {% if proposal.requested_ada %}
        <p class="text-sm text-slate-700">
          Requested:
          <span class="font-semibold">{{ proposal.requested_ada }}</span>
        </p>
      {% endif %}
    </div>

    {% if proposal.proposal_url %}
      <a
        href="{{ proposal.proposal_url }}"
        target="_blank"
        rel="noreferrer"
        class="inline-flex items-center gap-1 text-xs font-medium text-sky-700 hover:text-sky-800 underline underline-offset-2"
      >
        原文（Project Catalyst サイト）を開く ↗
      </a>
    {% endif %}
  </section>

  {# 指標 #}
  <section class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm">
    <div class="p-4 rounded-2xl bg-white/70 ring-1 ring-slate-200/60">
      <p class="text-xs font-medium text-slate-500">Votes cast</p>
      <p class="mt-1 text-base font-semibold text-slate-900">
        {{ (proposal.votes_cast or "-") | replace(".0","") }}
      </p>
    </div>
    <div class="p-4 rounded-2xl bg-white/70 ring-1 ring-slate-200/60">
      <p class="text-xs font-medium text-slate-500">Yes (ADA)</p>
      <p class="mt-1 text-base font-semibold text-slate-900">
        {{ (proposal.yes_amount or "-") | replace(".0","") }}
      </p>
    </div>
    <div class="p-4 rounded-2xl bg-white/70 ring-1 ring-slate-200/60">
      <p class="text-xs font-medium text-slate-500">Abstain (ADA)</p>
      <p class="mt-1 text-base font-semibold text-slate-900">
        {{ (proposal.abstain_amount or "-") | replace(".0","") }}
      </p>
    </div>
    <div class="p-4 rounded-2xl bg-white/70 ring-1 ring-slate-200/60">
      <p class="text-xs font-medium text-slate-500">Approval threshold</p>
      <p class="mt-1 text-base font-semibold text-slate-900">
        {{ proposal.meets_approval_threshold or "-" }}
      </p>
      {% if proposal.fund_depletion %}
        <p class="mt-1 text-xs text-slate-500">
          Fund depletion:
          {{ (proposal.fund_depletion or "-") | replace(".0","") }}
        </p>
      {% endif %}
      {% if proposal.not_funded_reason %}
        <p class="mt-1 text-xs text-rose-500">
          Reason (not funded): {{ proposal.not_funded_reason }}
        </p>
      {% endif %}
    </div>
  </section>

  {# タブ #}
  <section class="space-y-6">
    <div class="inline-flex items-center gap-2 rounded-full bg-slate-100 p-1 text-xs font-medium">
      <button
        type="button"
        class="px-4 py-1.5 rounded-full bg-white shadow-sm text-slate-900"
        data-tab-button="en"
      >
        English
      </button>
      <button
        type="button"
        class="px-4 py-1.5 rounded-full text-slate-600"
        data-tab-button="ja"
      >
        日本語
      </button>
      <button
        type="button"
        class="px-4 py-1.5 rounded-full text-slate-600"
        data-tab-button="easy"
      >
        やさしい解説
      </button>
      <button
        type="button"
        class="px-4 py-1.5 rounded-full text-slate-600"
        data-tab-button="es"
      >
        Español fácil
      </button>
    </div>

    <div class="space-y-8">
      {# ===========================
         English タブ
         =========================== #}
      <section id="tab-en" class="space-y-6" data-tab-panel="en">
        {% if proposal.problem_en or proposal.solution_en or proposal.about_en or proposal.team_en %}

          {# Problem #}
          <div class="p-4 rounded-2xl bg-white/80 ring-1 ring-slate-200/70 shadow-sm space-y-2">
            <h3 class="text-base font-semibold text-slate-900">Problem</h3>
            <p class="text-sm leading-relaxed text-slate-800 whitespace-pre-line">
              {{ proposal.problem_en or "—" }}
            </p>
          </div>

          {# Solution #}
          <div class="p-4 rounded-2xl bg-white/80 ring-1 ring-slate-200/70 shadow-sm space-y-2">
            <h3 class="text-base font-semibold text-slate-900">Solution</h3>
            <p class="text-sm leading-relaxed text-slate-800 whitespace-pre-line">
              {{ proposal.solution_en or "—" }}
            </p>
          </div>

          {# About this idea（LLMで整形された版があれば優先表示） #}
          {% if proposal.about_structured_en %}

            {# 1. Markdown → HTML に変換 #}
            {% set rendered = proposal.about_structured_en | markdown | safe %}

            <section class="space-y-3">
              <h3 class="text-base font-semibold text-slate-900">
                About this idea
                <span class="ml-1 text-[11px] font-normal text-slate-500">(structured)</span>
              </h3>

              {# 2. <hr> ごとに分割 #}
              {% set sections = rendered | split_hr_sections %}

              <div class="space-y-4">
                {% for section in sections %}
                  <article
                    class="rounded-2xl border border-slate-200 bg-white/95 p-4 sm:p-5 prose prose-sm max-w-none text-slate-800"
                  >
                    {{ section | safe }}
                  </article>
                {% endfor %}
              </div>

              <p class="pt-1 text-[11px] leading-snug text-slate-500">
                ※ This section is a structured summary generated from the proposal form. For full details, please also refer to the original Project Catalyst page.
              </p>
            </section>

          {% else %}

            {# まだ整形版がない場合は従来どおり about_en をそのまま表示 #}
            <div class="p-4 rounded-2xl bg-white/80 ring-1 ring-slate-200/70 shadow-sm space-y-2">
              <h3 class="text-base font-semibold text-slate-900">About this idea</h3>
              <div class="prose prose-sm max-w-none text-slate-800 max-h-72 overflow-y-auto pr-2">
                {{ (proposal.about_en or "—") | md_sanitize }}
              </div>
              <p class="mt-2 text-xs text-slate-500">
                ※ テキストが長い場合があります。全体は Project Catalyst の原文ページもあわせてご覧ください。
              </p>
            </div>
          {% endif %}

          {# Team #}
          <div class="p-4 rounded-2xl bg-white/80 ring-1 ring-slate-200/70 shadow-sm space-y-2">
            <h3 class="text-base font-semibold text-slate-900">Team</h3>
            <div class="text-sm leading-relaxed text-slate-800 whitespace-pre-line max-h-60 overflow-y-auto pr-2">
              {{ proposal.team_en or "—" }}
            </div>
          </div>

        {% else %}
          <p class="text-sm text-slate-700">
            詳しい内容は
            {% if proposal.proposal_url %}
              <a
                href="{{ proposal.proposal_url }}"
                class="text-sky-600 hover:text-sky-700 underline underline-offset-2"
                target="_blank"
                rel="noreferrer"
              >
                Project Catalyst の原文ページ
              </a>
            {% else %}
              Project Catalyst の原文ページ
            {% endif %}
            をご覧ください。
          </p>
        {% endif %}

        {% if proposal.proposal_url %}
          <div class="pt-2 border-t border-slate-200 mt-4">
            <a
              href="{{ proposal.proposal_url }}"
              class="inline-flex items-center gap-1 text-sm font-medium text-sky-700 hover:text-sky-800"
              target="_blank"
              rel="noreferrer"
            >
              原文（Project Catalyst サイト）を開く ↗
            </a>
          </div>
        {% endif %}
      </section>

      {# ===========================
         日本語タブ (structured_ja)
         =========================== #}
      <section id="tab-ja" class="space-y-6 hidden" data-tab-panel="ja">
        {% if proposal.about_structured_ja %}
          {% set rendered_ja = proposal.about_structured_ja | markdown | safe %}
          {% set sections_ja = rendered_ja | split_hr_sections %}

          <section class="space-y-3">
            <h3 class="text-base font-semibold text-slate-900">
              日本語まとめ
              <span class="ml-1 text-[11px] font-normal text-slate-500">(構造化された解説)</span>
            </h3>

            <div class="space-y-4">
              {% for section in sections_ja %}
                <article
                  class="rounded-2xl border border-slate-200 bg-white/95 p-4 sm:p-5 prose prose-sm max-w-none text-slate-800"
                >
                  {{ section | safe }}
                </article>
              {% endfor %}
            </div>

            <p class="pt-1 text-[11px] leading-snug text-slate-500">
              ※ Project Catalyst の提案フォームをもとに、日本語で構造的に整理した解説です。原文は英語タブや公式ページもあわせてご覧ください。
            </p>
          </section>
        {% else %}
          <div class="p-4 rounded-2xl bg-white/80 ring-1 ring-slate-200/70 shadow-sm space-y-2">
            <h3 class="text-base font-semibold text-slate-900">日本語</h3>
            <div class="prose prose-sm max-w-none text-slate-800">
              {{ (proposal.about_ja or "日本語訳は準備中です。") | md_sanitize }}
            </div>
          </div>
        {% endif %}
      </section>

      {# ===========================
         やさしい日本語タブ (ELPスタイル)
         =========================== #}
      <section id="tab-easy" class="space-y-6 hidden" data-tab-panel="easy">
        {# 値があれば ELP テキストを、なければ「準備中です」を表示 #}

        {% set ja_elp_raw = proposal.about_structured_ja_elp | default("", true) %}

        {% if ja_elp_raw | trim %}
          {# ★ about_structured_ja_elp が入っているときはこちら ★ #}
          {% set rendered_ja_elp = ja_elp_raw | markdown | safe %}
          {% set sections_ja_elp = rendered_ja_elp | split_hr_sections %}

          <section class="space-y-3">
            <h3 class="text-base font-semibold text-slate-900">
              やさしい日本語
              <span class="ml-1 text-[11px] font-normal text-slate-500">(ELPスタイル)</span>
            </h3>

            <div class="space-y-4">
              {% for section in sections_ja_elp %}
                <article
                  class="rounded-2xl border border-emerald-300 bg-white shadow-sm p-4 sm:p-5 prose prose-sm max-w-none text-slate-800"
                >
                  {{ section | safe }}
                </article>
              {% endfor %}
            </div>

            <p class="pt-1 text-[11px] leading-snug text-slate-500">
              ※ 重要なポイントだけを、シンプルでやさしい日本語にまとめたバージョンです。英語タブ・日本語タブとあわせて読み比べできます。
            </p>
          </section>

        {% else %}
          {# ★ まだ ELP テキストが JSON にないときはこちら ★ #}
          <p class="text-sm text-slate-700">
            やさしい日本語での解説は準備中です。
          </p>
        {% endif %}
      </section>


      {# ===========================
         Español fácil タブ (ELPスタイル)
         =========================== #}
      <section id="tab-es-easy" class="space-y-6 hidden" data-tab-panel="es">
        {# 値があれば ELP テキストを、なければ「準備中です」を表示 #}

        {% set es_elp_raw = proposal.about_structured_es_elp | default("", true) %}

        {% if es_elp_raw | trim %}
          {# ★ about_structured_es_elp が入っているときはこちら ★ #}
          {% set rendered_es_elp = es_elp_raw | markdown | safe %}
          {% set sections_es_elp = rendered_es_elp | split_hr_sections %}

          <section class="space-y-3">
            <h3 class="text-base font-semibold text-slate-900">
              Español fácil
              <span class="ml-1 text-[11px] font-normal text-slate-500">(ELPスタイル)</span>
            </h3>

            <div class="space-y-4">
              {% for section in sections_es_elp %}
                <article
                  class="rounded-2xl border border-emerald-300 bg-white shadow-sm p-4 sm:p-5 prose prose-sm max-w-none text-slate-800"
                >
                  {{ section | safe }}
                </article>
              {% endfor %}
            </div>

            <p class="pt-1 text-[11px] leading-snug text-slate-500">
              ※ 重要なポイントだけを、やさしいスペイン語（Español fácil）でまとめたバージョンです。
              英語・日本語・やさしい日本語タブとあわせて読み比べできます。
            </p>
          </section>

        {% else %}
          {# ★ まだ ELP テキストが JSON にないときはこちら ★ #}
          <p class="text-sm text-slate-700">
            Español fácil での解説は準備中です。
          </p>
        {% endif %}
      </section>
   </div>




  <footer class="pt-4">
    <a
      href="/"
      class="inline-flex items-center gap-1 text-sm text-slate-600 hover:text-slate-800"
    >
      ← 一覧に戻る
    </a>
  </footer>
</div>

<script>
  // シンプルなタブ切り替え
  (function () {
    const buttons = document.querySelectorAll("[data-tab-button]");
    const panels = document.querySelectorAll("[data-tab-panel]");

    function activate(tab) {
      buttons.forEach((btn) => {
        const isActive = btn.dataset.tabButton === tab;
        btn.classList.toggle("bg-white", isActive);
        btn.classList.toggle("shadow-sm", isActive);
        btn.classList.toggle("text-slate-900", isActive);
        btn.classList.toggle("text-slate-600", !isActive);
      });
      panels.forEach((panel) => {
        panel.classList.toggle("hidden", panel.dataset.tabPanel !== tab);
      });
    }

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => activate(btn.dataset.tabButton));
    });

    // 初期状態は English
    activate("en");
  })();
</script>
